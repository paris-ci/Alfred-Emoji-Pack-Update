name: Update Emoji Pack

on:
  schedule:
    # Run daily at 00:00 UTC to check for new emojibase releases
    - cron: '0 0 * * *'
  workflow_dispatch:
    # Allow manual triggering

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to commit and push changes
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Install dependencies
        run: |
          pip install requests
      
      - name: Get current emojibase version
        id: get-version
        run: |
          # Get the latest version from npm
          LATEST_VERSION=$(curl -s https://registry.npmjs.org/emojibase-data | jq -r '.["dist-tags"].latest')
          
          # Validate that we got a version
          if [ -z "$LATEST_VERSION" ] || [ "$LATEST_VERSION" = "null" ]; then
            echo "Error: Failed to fetch latest version from npm registry"
            exit 1
          fi
          
          echo "Latest version: $LATEST_VERSION"
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          
          # Extract major version
          MAJOR_VERSION=$(echo $LATEST_VERSION | cut -d. -f1)
          echo "major_version=$MAJOR_VERSION" >> $GITHUB_OUTPUT
          
          # Check if we have a stored version
          if [ -f .github/.emojibase-version ]; then
            STORED_VERSION=$(cat .github/.emojibase-version)
            STORED_MAJOR=$(echo $STORED_VERSION | cut -d. -f1)
            echo "Stored version: $STORED_VERSION (major: $STORED_MAJOR)"
            echo "stored_version=$STORED_VERSION" >> $GITHUB_OUTPUT
            echo "stored_major=$STORED_MAJOR" >> $GITHUB_OUTPUT
          else
            echo "No stored version found"
            echo "stored_version=" >> $GITHUB_OUTPUT
            echo "stored_major=" >> $GITHUB_OUTPUT
          fi
      
      - name: Check if major version changed
        id: check-update
        run: |
          LATEST_MAJOR="${{ steps.get-version.outputs.major_version }}"
          STORED_MAJOR="${{ steps.get-version.outputs.stored_major }}"
          
          # Validate that major versions are numeric
          if [ -z "$LATEST_MAJOR" ] || ! [[ "$LATEST_MAJOR" =~ ^[0-9]+$ ]]; then
            echo "Error: Latest major version is missing or not numeric: '$LATEST_MAJOR'"
            exit 1
          fi
          
          if [ -z "$STORED_MAJOR" ]; then
            echo "First run, initializing with version $LATEST_MAJOR"
            echo "should_update=true" >> $GITHUB_OUTPUT
          else
            # Ensure stored major is numeric before comparison
            if ! [[ "$STORED_MAJOR" =~ ^[0-9]+$ ]]; then
              echo "Error: Stored major version is not numeric: $STORED_MAJOR"
              exit 1
            fi
            
            if [ "$STORED_MAJOR" -lt "$LATEST_MAJOR" ]; then
              echo "Major version increased from $STORED_MAJOR to $LATEST_MAJOR"
              echo "should_update=true" >> $GITHUB_OUTPUT
            elif [ "$STORED_MAJOR" -eq "$LATEST_MAJOR" ]; then
              echo "Major version unchanged (current: $LATEST_MAJOR)"
              echo "should_update=false" >> $GITHUB_OUTPUT
            else
              echo "Latest major version ($LATEST_MAJOR) is older than stored version ($STORED_MAJOR) - skipping"
              echo "should_update=false" >> $GITHUB_OUTPUT
            fi
          fi
      
      - name: Run main.py
        if: steps.check-update.outputs.should_update == 'true'
        run: |
          set -e  # Exit on any error
          echo "Running main.py to generate emoji snippets..."
          python main.py
          echo "main.py completed successfully"
      
      - name: Configure git
        if: steps.check-update.outputs.should_update == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
      
      - name: Commit and push changes
        id: commit-snippets
        if: steps.check-update.outputs.should_update == 'true'
        run: |
          set -e  # Exit on any error
          
          # Verify snippets directory exists and contains generated files
          if [ ! -d "snippets" ]; then
            echo "Error: Snippets directory does not exist"
            exit 1
          fi
          
          if ! find snippets -name '*.alfredsnippets' -type f 2>/dev/null | grep -q .; then
            echo "Error: No snippet files were generated"
            exit 1
          fi
          
          git add snippets/
          if git diff --staged --quiet; then
            echo "No changes to commit"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            git commit -m "Update emoji pack to emojibase ${{ steps.get-version.outputs.latest_version }}"
            git push
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Store version
        if: steps.check-update.outputs.should_update == 'true' && steps.commit-snippets.outputs.has_changes == 'true'
        run: |
          set -e  # Exit on any error
          mkdir -p .github
          echo "${{ steps.get-version.outputs.latest_version }}" > .github/.emojibase-version
          git add .github/.emojibase-version
          git commit -m "Update tracked emojibase version to ${{ steps.get-version.outputs.latest_version }}"
          git push
